<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>2Ski</title>
<style>

body
{
	background: #d5f6ff;
	margin: 0; padding: 0;
	overflow: hidden;
}

canvas
{
	position: fixed;
}

</style>
<body>
<script>

"use strict";

Math.PI2 = Math.PI2 || Math.PI/2;
Math.TAU = Math.TAU || Math.PI*2;
Math.SINPI2 = Math.SINPI2 || Math.sin( Math.PI2 );

var requestAnimFrame =
		window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.requestAnimationFrame ||
		function( callback )
		{
			setTimeout( callback, 16 );
		},
	playersLength = 2,
	players = [],
	atlas,
	ratio,
	width,
	height,
	centerX,
	centerY,
	viewLeft,
	viewRight,
	viewTop,
	viewBottom,
	skierScreenTop,
	skierScreenBottom,
	pointerLength = 0,
	pointerX = [],
	pointerY = [],
	keysDown = [],
	now,
	last,
	factor,
	objectsLength,
	objects = [],
	flakesLength,
	flakes = [],
	flake,
	equipmentLength = 4,
	sprites = {},
	mobile = navigator.userAgent.match(
		/ipad|iphone|ipod|android|blackberry|webos/i ),
	orientationsLength = 36,
	steepness = .2,
	gravityVector = -Math.PI2,
	gravityX = Math.cos( gravityVector )*steepness,
	gravityY = Math.sin( gravityVector )*steepness,
	gravityLength = Math.sqrt( gravityX*gravityX + gravityY*gravityY ),
	indexFactor = orientationsLength/2/Math.PI,
	reverseFactor = 1/Math.PI2,
	maxSpeedFactor,
	slopeWidth,
	slopeHeight,
	skiWidth,
	skiGap2,
	skiGap2PlusSki2,
	skiGap2MinusSki2,
	skiLength2,
	marksFrequency = 240,
	flakeFrequency = 10,
	leanFactor = 3/Math.PI2;

function drawFlakes( ctx, left, top, upsideDown )
{
	for( var n = flakesLength; n--; )
	{
		var f = flakes[n];

		if( !f.life )
			continue;

		f.x += f.vx*factor;
		f.y += f.vy*factor;

		var x = f.x-left,
			y = f.y-top;

		if( upsideDown )
			y = height-y;

		var sprite = f.sprite;

		x -= sprite.centerX;
		y -= sprite.centerY;

		--f.life;
		ctx.drawImage( sprite, x, y );
	}
}

function turnAround( angle )
{
	return (Math.PI-angle+Math.TAU) % Math.TAU;
}

function drawEquipment( equipment, ctx, left, top, upsideDown )
{
	for( var n = equipmentLength; n--; )
	{
		var e = equipment[n],
			x = e.x-left,
			y = e.y-top,
			vx = e.vx,
			vy = e.vy;

		if( Math.max( Math.abs( vx ), Math.abs( vy ) ) > .2 )
			e.angle = (e.angle+.03*(vx*vy)+Math.TAU) % Math.TAU;

		var angle = e.angle;

		if( upsideDown )
		{
			angle = turnAround( angle );
			y = height-y;
		}

		vx -= vx*maxSpeedFactor;
		vy -= vy*maxSpeedFactor;

		e.x += vx;
		e.y += vy;
		e.vx = vx;
		e.vy = vy;

		var sprite = e.sprite[indexFactor*angle | 0];

		x -= sprite.centerX;
		y -= sprite.centerY;

		ctx.drawImage( sprite, x, y );
	}
}

function drawPlayers( ctx, left, top, upsideDown )
{
	for( var n = playersLength; n--; )
	{
		var p = players[n],
			heading = (p.skiAngle+Math.PI2) % Math.TAU,
			x = p.x-left,
			y = p.y-top;

		if( upsideDown )
		{
			heading = turnAround( heading );
			y = height-y;
		}

		if( p.crashed )
			drawEquipment(
				p.equipment,
				ctx,
				left,
				top,
				upsideDown );

		var sprite = p.sprites[p.sprite][indexFactor*heading | 0];

		x -= sprite.centerX;
		y -= sprite.centerY;

		ctx.drawImage( sprite, x, y );

		if( p.crashed )
			continue;

		x = p.x;
		y = p.y;

		var m = p.mark,
			sx = p.sx,
			sy = p.sy,
			lx = sx*skiLength2,
			ly = sy*skiLength2,
			leftX = x+sy*skiGap2PlusSki2,
			leftY = y+sx*skiGap2PlusSki2,
			rightX = x+sy*skiGap2MinusSki2,
			rightY = y+sx*skiGap2MinusSki2;

		p.marksLeftTopX[m] = leftX+lx | 0;
		p.marksLeftTopY[m] = leftY+ly | 0;
		p.marksLeftBottomX[m] = rightX-lx | 0;
		p.marksLeftBottomY[m] = rightY-ly | 0;

		leftX = x-sy*skiGap2MinusSki2;
		leftY = y+sx*skiGap2MinusSki2;
		rightX = x-sy*skiGap2PlusSki2,
		rightY = y+sx*skiGap2PlusSki2,

		p.marksRightTopX[m] = leftX+lx | 0;
		p.marksRightTopY[m] = leftY+ly | 0;
		p.marksRightBottomX[m] = rightX-lx | 0;
		p.marksRightBottomY[m] = rightY-ly | 0;

		if( now-p.lastMark > marksFrequency )
		{
			/*if( leftX != p.marksLastX ||
				leftY != p.marksLastY )
			{
				p.marksLastX = leftX;
				p.marksLastY = leftY;

				++p.mark;
			}*/
			if( sx != p.marksLastX ||
				sy != p.marksLastY )
			{
				p.marksLastX = sx;
				p.marksLastY = sy;

				++p.mark;
			}

			p.lastMark = now;
		}
	}
}

function crash( player )
{
	if( player.crashed )
		return;

	player.controllable = false;
	player.crashed = true;
	player.sprite = 7;

	var equipment = player.equipment;

	for( var n = equipmentLength; n--; )
	{
		var e = equipment[n],
			vx = player.vx,
			vy = player.vy,
			r = Math.random(),
			f = .75+r*.5;

		r = (r-.5)*skiLength2;

		e.x = player.x+r;
		e.y = player.y+r;
		e.vx = vx*f;
		e.vy = vy*f;
		e.angle = (player.skiAngle+r+Math.TAU) % Math.TAU;
	}
}

function drawObjects( ctx, left, top, upsideDown, player )
{
	var px = player.x,
		py = player.y;

	for( var n = objectsLength; n--; )
	{
		var o = objects[n],
			ox = o.x,
			oy = o.y,
			x = ox-left,
			y = oy-top,
			sprite;

		if( upsideDown )
		{
			sprite = sprites.treeUpsideDown;
			y = height-y;
		}
		else
			sprite = sprites.tree;

		if( x > viewRight ||
			x < viewLeft ||
			y > viewBottom ||
			y < viewTop )
			continue;

		var cx = sprite.centerX,
			cy = sprite.centerY;

		if( !player.crashed &&
			py >= oy-cy &&
			py <= oy+cy &&
			px >= ox-cx &&
			px <= ox+cx )
			crash( player );

		x -= cx;
		y -= cy;

		ctx.drawImage( sprite, x, y );
	}
}

function drawMarks( ctx, left, top )
{
	ctx.fillStyle = "#b5d6df";

	for( var n = playersLength; n--; )
	{
		var p = players[n],
			l = p.mark,
			topX = p.marksLeftTopX,
			topY = p.marksLeftTopY,
			bottomX = p.marksLeftBottomX,
			bottomY = p.marksLeftBottomY;

		if( !l )
			continue;

		for( var s = 2; s--; )
		{
			/*var m = l,
				set = false;

			ctx.beginPath();

			while( m-- )
			{
				var x = topX[m]-left,
					y = topY[m]-top;

				if( !set )
				{
					ctx.moveTo( x, y );
					set = true;
				}
				else
					ctx.lineTo( x, y );

				if( y > height )
					break;
			}

			do
			{
				var x = bottomX[m]-left,
					y = bottomY[m]-top;

				ctx.lineTo( x, y );

			} while( ++m < l );

			ctx.closePath();
			ctx.fill();*/

			for( var m = l; ; )
			{
				var next = m,
					y;

				if( --next < 0 )
					break;

				ctx.beginPath();

				ctx.moveTo(
					topX[m]-left,
					topY[m]-top );
				ctx.lineTo(
					bottomX[m]-left,
					bottomY[m]-top );

				ctx.lineTo(
					bottomX[next]-left,
					(y = bottomY[next]-top) );
				ctx.lineTo(
					topX[next]-left,
					topY[next]-top );

				ctx.closePath();
				ctx.fill();

				if( y > height )
					break;

				m = next;
			}

			if( !s )
				break;

			topX = p.marksRightTopX;
			topY = p.marksRightTopY;
			bottomX = p.marksRightBottomX;
			bottomY = p.marksRightBottomY;
		}
	}
}

function draw()
{
	for( var n = playersLength; n--; )
	{
		var p = players[n],
			ctx = p.ctx,
			ud = p.upsideDown,
			x = p.x,
			y = p.y,
			left = x-centerX,
			top = y-skierScreenTop,
			right = x+centerX,
			bottom = y+skierScreenBottom;

		ctx.fillStyle = n & 1 ? "#d5f6ff" : "#c5e6ef";
		ctx.fillRect( 0, 0, width, height );

		//drawMarks( ctx, left, top );
		drawObjects( ctx, left, top, ud, p );
		drawFlakes( ctx, left, top, ud );
		drawPlayers( ctx, left, top, ud );
	}
}

function turn( player, mod )
{
	player.skiAngle = (player.skiAngle+mod+Math.TAU) % Math.TAU;
}

function input()
{
	var step = .05,
		p;

	if( (p = players[0]).controllable )
	{
		if( keysDown[65] )
			turn( p, -step );
		else if( keysDown[68] )
			turn( p, step );
	}

	if( playersLength > 1 &&
		(p = players[1]).controllable )
	{
		if( keysDown[37] )
			turn( p, -step );
		else if( keysDown[39] )
			turn( p, step );
	}

	if( playersLength > 2 &&
		(p = players[2]).controllable )
	{
		if( keysDown[72] )
			turn( p, -step );
		else if( keysDown[76] )
			turn( p, step );
	}

	for( var n = pointerLength; n--; )
	{
		var x = pointerX[n],
			y = pointerY[n],
			p = players[x/width | 0];

		if( !p.controllable )
			continue;

		turn( p, -step/centerX*(centerX-(x % width)) );
	}
}

function spray( x, y, vx, vy )
{
	var f = flakes[flake];

	f.x = x;
	f.y = y;
	f.vx = vx;
	f.vy = vy;
	f.life = 100;

	if( ++flake >= flakesLength )
		flake = 0;
}

function roll( p )
{
	var vx = p.vx,
		vy = p.vy,
		speed = Math.max( Math.abs( vx ), Math.abs( vy ) );

	if( speed < .1 )
	{
		p.stopped = true;
		return;
	}

	vx -= vx*maxSpeedFactor;
	vy -= vy*maxSpeedFactor;

	p.x += vx;
	p.y += vy;
	p.vx = vx;
	p.vy = vy;
	p.skiAngle = (p.skiAngle+.03*(vx+vy)+Math.TAU) % Math.TAU;

	if( speed > .8 &&
		now-p.lastFlake > flakeFrequency )
	{
		var r = Math.random(),
			f = r*.25;

		vx *= f;
		vy *= f;
		r = (r-.5)*skiLength2;

		spray( p.x+r, p.y+r, -vx, -vy );

		p.lastFlake = now;
	}
}

function ski( p )
{
	var skiAngle = p.skiAngle,
		sx = (p.sx = Math.cos( skiAngle )),
		sy = (p.sy = Math.sin( skiAngle )),
		vx = p.vx,
		vy = p.vy,
		vd = (Math.atan2( vy, vx )-skiAngle+Math.TAU) % Math.TAU,
		a = gravityVector-skiAngle,
		d = (a+Math.TAU) % Math.TAU,
		x,
		y;

	// lean into curve
	if( vd > Math.PI )
		vd -= Math.TAU;

	p.lean += (vd*leanFactor-p.lean)*.1*factor;
	/*p.sprite = 3+Math.max( -3, Math.min( 3, Math.round( p.lean ) ) );*/
	p.sprite = 3+Math.max( -3, Math.min( 3, Math.round(
		p.lean+(p.lean > 0 ? .3 : -.3) ) ) );

	// difference from -PI to +PI
	if( d > Math.PI )
		d -= Math.TAU;

	var r = Math.abs( d );

	// translate maximum to PI/2
	if( d > Math.PI2 )
		d = Math.PI2-d+Math.PI2;
	else if( d < -Math.PI2 )
		d = -Math.PI2-d+-Math.PI2;

	if( d > 0 )
	{
		x = sy;
		y = -sx;
	}
	else
	{
		x = -sy;
		y = sx;
	}

	var l = gravityLength*
		Math.sin( Math.abs( d ) )/
		Math.SINPI2;

	x *= l;
	y *= l;

	x += gravityX;
	y += gravityY;

	// moving backwards should be slower
	if( r > Math.PI2 )
	{
		r = 1-reverseFactor*(r-Math.PI2);
		x *= r;
		y *= r;
	}

	// timing
	x *= factor;
	y *= factor;

	vx += x;
	vy += y;

	// resistance
	vx -= vx*maxSpeedFactor;
	vy -= vy*maxSpeedFactor;

	p.x += vx;
	p.y += vy;
	p.vx = vx;
	p.vy = vy;

	if( now-p.lastFlake > flakeFrequency &&
		Math.abs( vd ) > .4 &&
		(vx || vy) )
	{
		var r = Math.random(),
			f = r*.25,
			l = skiLength2*r;

		vx *= f;
		vy *= f;

		x = p.x-sx*l;
		y = p.y-sy*l;

		if( vd > 0 )
			spray( x, y, -vy, vx );
		else if( vd < 0 )
			spray( x, y, vy, -vx );

		p.lastFlake = now;
	}
}

function move()
{
	var moving = 0;

	for( var n = playersLength; n--; )
	{
		var p = players[n];

		if( p.stopped )
			continue;

		if( p.crashed )
			roll( p );
		else
		{
			if( p.y < 0 )
			{
				if( p.controllable )
					p.controllable = false;

				if( Math.abs( p.vx )+Math.abs( p.vy ) > .3 &&
					p.skiAngle > Math.PI2 )
					turn( p, .1 );
				else
					p.stopped = true;
			}

			ski( p );
		}

		++moving;
	}

	// check if players collide
	for( var a = 0; a < playersLength; )
	{
		var p1 = players[a];

		if( p1.crashed )
		{
			++a;
			continue;
		}

		for( var b = ++a; b < playersLength; ++b )
		{
			var p2 = players[b];

			if( Math.abs( p1.x-p2.x ) < skiLength2 &&
				Math.abs( p1.y-p2.y ) < skiLength2 )
			{
				crash( p1 );
				crash( p2 );
			}
		}
	}

	return moving;
}

function run()
{
	now = new Date().getTime();
	factor = 16/(now-last);
	last = now;

	input();

	if( !move() )
		reset();

	draw();

	requestAnimFrame( run );
}

function getEvent( ev )
{
	return ev || event;
}

function setPointers( ev, set )
{
	var e = getEvent( ev );

	if( e.touches )
	{
		pointerLength = e.touches.length;

		for( var n = 0; n < pointerLength; ++n )
		{
			var t = e.touches[n];

			pointerX[n] = t.pageX*ratio;
			pointerY[n] = t.pageY*ratio;
		}
	}
	else if( typeof e.clientX !== "undefined" )
	{
		pointerX[0] = e.clientX*ratio;
		pointerY[0] = e.clientY*ratio;
		pointerLength = 1;
	}
	else if( typeof e.pageX !== "undefined" )
	{
		pointerX[0] = e.pageX*ratio;
		pointerY[0] = e.pageY*ratio;
		pointerLength = 1;
	}

	e.preventDefault();
	return false;
}

function pointerUp( ev )
{
	pointerLength = 0;

	getEvent( ev ).preventDefault();
	return false;
}

function pointerMove( ev )
{
	if( pointerLength )
		return setPointers( ev );

	getEvent( ev ).preventDefault();
	return false;
}

function pointerDown( ev )
{
	return setPointers( ev );
}

function setKey( ev, pressed )
{
	var e = getEvent( ev );

	keysDown[e.keyCode] = pressed;

	e.preventDefault();
	return false;
}

function keyUp( ev )
{
	return setKey( ev, false );
}

function keyDown( ev )
{
	return setKey( ev, true );
}

function reset()
{
	var ref = sprites.skierBlueStraight[0],
		rw = ref.width,
		rh = ref.height;

	maxSpeedFactor = 3/rh;

	slopeWidth = rw*playersLength*3;
	slopeHeight = sprites.tree.height*70;

	if( (skiWidth = rw*.1 | 0) < 2 )
		skiWidth = 2;

	if( (skiGap2 = rw*.0398 | 0) < 1 )
		skiGap2 = 1;

	skiGap2PlusSki2 = skiGap2+(skiWidth >> 1);
	skiGap2MinusSki2 = skiGap2-(skiWidth >> 1);
	skiLength2 = rh >> 1;

	objectsLength = 0;
	objects = [];

	for( var y = 1-(1/slopeHeight*rh*4);
		y > 0;
		y -= Math.random()*.05 )
	{
		var x = Math.random();

		objects[objectsLength] = {
			x: x*.1*slopeWidth | 0,
			y: y*slopeHeight | 0,
			sprite: sprites.tree };
		++objectsLength;

		objects[objectsLength] = {
			x: (.9+x*.1)*slopeWidth | 0,
			y: y*slopeHeight | 0,
			sprite: sprites.tree };
		++objectsLength;

		objects[objectsLength] = {
			x: (objectsLength % 2 ?
				(x < .5 ? 0 : .9)+x*.1 :
				x)*slopeWidth | 0,
			y: y*slopeHeight | 0,
			sprite: sprites.tree };
		++objectsLength;
	}

	flakesLength = 100;
	flakes = [];
	flake = 0;

	for( var n = flakesLength; n--; )
		flakes[n] = {
			life: 0,
			sprite: sprites["flake"+(1+(Math.random()*3 | 0))] };

	var cell = slopeWidth/playersLength,
		margin = rh << 1,
		x = cell >> 1,
		y = slopeHeight-margin;

	skierScreenTop = height-margin;
	skierScreenBottom = margin;

	for( var n = 0;
		n < playersLength;
		++n, x += cell )
	{
		var p = players[n];

		p.x = x;
		p.y = y;
		p.controllable = true;
		p.crashed = false;
		p.stopped = false;

		p.vx =
		p.vy =
		p.sx =
		p.sy =
		p.lean =
		p.sprite = 0;

		p.skiAngle = -Math.PI2;

		p.lastMark =
		p.lastFlake = 0;

		p.mark =
		p.marksLastX =
		p.marksLastY = 0;
		p.marksLeftTopX = [];
		p.marksLeftTopY = [];
		p.marksLeftBottomX = [];
		p.marksLeftBottomY = [];
		p.marksRightTopX = [];
		p.marksRightTopY = [];
		p.marksRightBottomX = [];
		p.marksRightBottomY = [];

		p.equipment = [
			{ sprite: sprites.pole },
			{ sprite: sprites.pole },
			{ sprite: sprites.ski },
			{ sprite: sprites.ski }];

		var base = n & 1 ? "skierYellow" : "skierBlue",
			actions = [
				"LeanRight3",
				"LeanRight2",
				"LeanRight1",
				"Straight",
				"LeanLeft1",
				"LeanLeft2",
				"LeanLeft3",
				"Crashed"];

		p.sprites = [];
		for( var i = 0, l = actions.length; i < l; ++i )
			p.sprites[i] = sprites[base+actions[i]];
	}
}

function scale( styleWidth )
{
	var frames = {
			skierBlueStraight: {
				rotate: true,
				frame: {/*skier-blue-straight*/x:1453,y:2,w:103,h:222}
			},
			skierBlueJump: {
				rotate: true,
				frame: {/*skier-blue-jump*/x:1129,y:2,w:196,h:222}
			},
			skierBlueLeanLeft1: {
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:827,y:2,w:98,h:242}
			},
			skierBlueLeanLeft2: {
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:138,y:2,w:132,h:262}
			},
			skierBlueLeanLeft3: {
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:400,y:2,w:122,h:257}
			},
			skierBlueLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:827,y:2,w:98,h:242}
			},
			skierBlueLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:138,y:2,w:132,h:262}
			},
			skierBlueLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:400,y:2,w:122,h:257}
			},
			skierBlueCrashed: {
				rotate: true,
				frame: {/*skier-blue-crashed*/x:1694,y:2,w:130,h:173}
			},
			skierYellowStraight: {
				rotate: true,
				frame: {/*skier-yellow-straight*/x:1346,y:2,w:103,h:222}
			},
			skierYellowJump: {
				rotate: true,
				frame: {/*skier-yellow-jump*/x:929,y:2,w:196,h:222}
			},
			skierYellowLeanLeft1: {
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:725,y:2,w:98,h:242}
			},
			skierYellowLeanLeft2: {
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:2,y:2,w:132,h:262}
			},
			skierYellowLeanLeft3: {
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:274,y:2,w:122,h:257}
			},
			skierYellowLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:725,y:2,w:98,h:242}
			},
			skierYellowLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:2,y:2,w:132,h:262}
			},
			skierYellowLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:274,y:2,w:122,h:257}
			},
			skierYellowCrashed: {
				rotate: true,
				frame: {/*skier-yellow-crashed*/x:1560,y:2,w:130,h:173}
			},
			pole: {
				rotate: true,
				frame: {/*pole*/x:1828,y:2,w:13,h:117}
			},
			ski: {
				rotate: true,
				frame: {/*ski*/x:1329,y:2,w:13,h:222}
			},
			tree: {
				frame: {/*tree*/x:526,y:2,w:195,h:256}
			},
			treeUpsideDown: {
				upsideDown: true,
				frame: {/*tree*/x:526,y:2,w:195,h:256}
			},
			flake1: {
				frame: {/*flake1*/x:1961,y:2,w:26,h:26}
			},
			flake2: {
				frame: {/*flake2*/x:1927,y:2,w:30,h:30}
			},
			flake3: {
				frame: {/*flake3*/x:1889,y:2,w:34,h:34}
			},
			flake4: {
				frame: {/*flake4*/x:1845,y:2,w:40,h:40}
			}
		},
		step = Math.TAU/orientationsLength,
		scale = Math.min( width, height )*.1/
			frames.skierBlueStraight.frame.w;

	if( scale > 1 )
		scale = 1;

	sprites = {};

	for( var name in frames )
	{
		var sprite = frames[name],
			f = sprite.frame,
			w = f.w*scale | 0,
			h = f.h*scale | 0;

		if( sprite.rotate )
		{
			var size = Math.max( w, h ),
				center = size >> 1,
				a = [];

			for( var o = orientationsLength; o--; )
			{
				var c = document.createElement( "canvas" ),
					x = c.getContext( "2d" ),
					angle = o*step;

				c.width = size;
				c.height = size;

				c.centerX = center;
				c.centerY = center;

				if( sprite.mirror )
				{
					x.setTransform( -1, 0, 0, 1, 0, 0 );
					x.translate( -center, center );
					x.rotate( -angle );
				}
				else if( sprite.upsideDown )
				{
					x.setTransform( -1, 0, 0, -1, 0, 0 );
					x.translate( -center, -center );
					x.rotate( -angle );
				}
				else
				{
					x.translate( center, center );
					x.rotate( angle );
				}

				x.drawImage(
					atlas,
					f.x,
					f.y,
					f.w,
					f.h,
					-w >> 1,
					-h >> 1,
					w,
					h );

				a[o] = c;
			}

			sprites[name] = a;
		}
		else
		{
			var c = document.createElement( "canvas" ),
				x = c.getContext( "2d" ),
				l = 0,
				t = 0;

			c.width = w;
			c.height = h;

			c.centerX = w >> 1;
			c.centerY = h >> 1;

			if( sprite.mirror )
			{
				x.setTransform( -1, 0, 0, 1, 0, 0 );
				l = -w;
			}
			else if( sprite.upsideDown )
			{
				x.setTransform( -1, 0, 0, -1, 0, 0 );
				l = -w;
				t = -h;
			}

			x.drawImage(
				atlas,
				f.x,
				f.y,
				f.w,
				f.h,
				l,
				t,
				w,
				h );

			sprites[name] = c;
		}
	}

	var sprite = sprites.tree,
		w = sprite.width,
		h = sprite.height;

	viewLeft = -w;
	viewRight = width+w;
	viewTop = -h;
	viewBottom = height+h;
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	w = w/playersLength | 0;

	for( var n = 0, x = 0;
		n < playersLength;
		++n, x += w )
	{
		var s = players[n].canvas.style;

		s.left = x+"px";
		s.top = "0px";
	}

	width = w*ratio | 0;
	height = h*ratio | 0;

	centerX = width >> 1;
	centerY = height >> 1;

	for( var n = playersLength; n--; )
	{
		var p = players[n],
			c = p.canvas;

		c.width = width;
		c.height = height;

		c.style.width = w+"px";
		c.style.height = h+"px";

		p.upsideDown = mobile ? (n & 1 ? false : true) : false;
	}

	scale( w );
	reset();
}

function create()
{
	var x;

	for( var n = playersLength; n--; )
	{
		var c;

		if( !(c = document.createElement( "canvas" )) ||
			!(x = c.getContext( "2d" )) )
			return;

		c.playerIndex = n;

		players[n] = {
			canvas: c,
			ctx: x };
	}

	ratio =
		(window.devicePixelRatio || 1)/
		(x.webkitBackingStorePixelRatio ||
			x.mozBackingStorePixelRatio ||
			x.msBackingStorePixelRatio ||
			x.oBackingStorePixelRatio ||
			x.backingStorePixelRatio ||
			1);
}

function init()
{
	if( !atlas )
	{
		atlas = new Image();
		atlas.src = "atlas.png";
	}

	if( !atlas.complete )
	{
		setTimeout( init, 1000 );
		return;
	}

	create();
	resize();

	var e = document.body;

	for( var n = playersLength; n--; )
		e.appendChild( players[n].canvas );

	window.onresize = resize;

	e.onkeydown = keyDown;
	e.onkeyup = keyUp;

	e.onmousedown = pointerDown;
	e.onmousemove = pointerMove;
	e.onmouseup = pointerUp;
	e.onmouseout = pointerUp;

	if( "ontouchstart" in e )
	{
		e.ontouchstart = pointerDown;
		e.ontouchmove = pointerMove;
		e.ontouchend = pointerUp;
	}

function stats(){var script=document.createElement('script');script.src='http://github.com/mrdoob/stats.js/raw/master/build/stats.min.js';document.body.appendChild(script);script=document.createElement('script');script.innerHTML='var interval=setInterval(function(){if(typeof Stats==\'function\'){clearInterval(interval);var stats=new Stats();stats.domElement.style.position=\'fixed\';stats.domElement.style.left=\'0px\';stats.domElement.style.top=\'0px\';stats.domElement.style.zIndex=\'10000\';document.body.appendChild(stats.domElement);setInterval(function(){stats.update();},1000/60);}},100);';document.body.appendChild(script);}stats();

	last = new Date().getTime()-16;
	run();
}

window.onload = init;

</script>
</body>
</html>
