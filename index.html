<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>2Ski!</title>
<style>

body
{
	background: #d5f6ff;
	margin: 0; padding: 0;
	overflow: hidden;
}

</style>
<body>
<canvas id="Ski">Sorry, your browser's lacking a
&lt;canvas&gt; implementation.</canvas>
<script>

"use strict";

// Mr. Doob's Stats
function stats()
{
var script=document.createElement('script');script.src='http://github.com/mrdoob/stats.js/raw/master/build/stats.min.js';document.body.appendChild(script);script=document.createElement('script');script.innerHTML='var interval=setInterval(function(){if(typeof Stats==\'function\'){clearInterval(interval);var stats=new Stats();stats.domElement.style.position=\'fixed\';stats.domElement.style.left=\'0px\';stats.domElement.style.top=\'0px\';stats.domElement.style.zIndex=\'10000\';document.body.appendChild(stats.domElement);setInterval(function(){stats.update();},1000/60);}},100);';document.body.appendChild(script);
}

// shim layer with setTimeout fallback
// see http://paulirish.com/2011/requestanimationframe-for-smart-animating/
window.requestAnimFrame =
	window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function( callback, element )
	{
		window.setTimeout(
			function()
			{
				callback( new Date().getTime() );
			},
			16 );
	};

var objects = {
		skier1: {
			res: [
				{/*skier1-straight*/x:121,y:335,w:25,h:54},
				{/*skier1-lean1-left*/x:208,y:256,w:24,h:59},
				{/*skier1-lean2-left*/x:92,y:256,w:32,h:64},
				{/*skier1-lean3-left*/x:154,y:256,w:30,h:63},
				{/*skier1-jump*/x:48,y:335,w:48,h:54},
				{/*skier1-crashed*/x:178,y:335,w:32,h:42}]
		},
		skier2: {
			res: [
				{/*skier2-straight*/x:96,y:335,w:25,h:54},
				{/*skier2-lean1-left*/x:184,y:256,w:24,h:59},
				{/*skier2-lean3-left*/x:124,y:256,w:30,h:63},
				{/*skier2-lean2-left*/x:60,y:256,w:32,h:64},
				{/*skier2-jump*/x:0,y:335,w:48,h:54},
				{/*skier2-crashed*/x:146,y:335,w:32,h:42}]
		},
		tree: {
			res: [{/*tree*/x:0,y:256,w:60,h:79}] },
		hump: {
			res: [{/*hump*/x:0,y:0,w:256,h:256}] }
	},
	atlas,
	canvas,
	ctx,
	ratio,
	width,
	height,
	centerX,
	centerY,
	pointerSet = false,
	pointers = 0,
	pointerX = [],
	pointerY = [],
	now,
	last,
	factor,
	playerX,
	playerY;

function drawPlayers()
{
	var sprite = objects.skier1.sprites[0];

	ctx.drawImage(
		sprite,
		playerX-sprite.centerX,
		playerY-sprite.centerY );
}

function draw()
{
	ctx.clearRect( 0, 0, width, height );

	var bottom = centerY+playerY;

	drawPlayers();
}

function run( now )
{
	factor = 16/(now-last);
	last = now;

	draw();

	requestAnimFrame( run );
}

function setPointers( ev )
{
	var e = ev || event;

	if( e.touches )
	{
		pointers = e.touches.length;

		for( var n = 0; n < pointers; ++n )
		{
			var t = e.touches[n];

			pointerX[n] = t.pageX;
			pointerY[n] = t.pageY;
		}
	}
	else if( typeof e.clientX !== "undefined" )
	{
		pointerX[0] = e.clientX;
		pointerY[0] = e.clientY;
		pointers = 1;
	}
	else if( typeof e.pageX !== "undefined" )
	{
		pointerX[0] = e.pageX;
		pointerY[0] = e.pageY;
		pointers = 1;
	}
}

function pointerUp( ev )
{
	pointerSet = false;

	ev.preventDefault();
	return false;
}

function pointerMove( ev )
{
	if( pointerSet )
		setPointers( ev );

	ev.preventDefault();
	return false;
}

function pointerDown( ev )
{
	pointerSet = true;

	ev.preventDefault();
	return false;
}

function reset()
{
	playerX = centerX;
	playerY = centerY*1.5 | 0;
}

function scale( styleWidth )
{
	var ref = objects.hump.res[0].w,
		scale;

	if( styleWidth >= ref )
		scale = 1;
	else
		scale = width/ref;

	for( var name in objects )
	{
		var o = objects[name],
			res = o.res;

		o.sprites = [];

		for( var n = res.length; n--; )
		{
			var r = res[n],
				c = document.createElement( "canvas" ),
				x = c.getContext( "2d" ),
				w = r.w*scale | 0,
				h = r.h*scale | 0;

			c.width = w;
			c.height = h;
			c.centerX = w >> 1;
			c.centerY = h >> 1;

			x.drawImage(
				atlas,
				r.x,
				r.y,
				r.w,
				r.h,
				0,
				0,
				w,
				h );

			o.sprites[n] = c;
		}

		if( o.rotate )
		{
			// 0  - 10: idx 0
			// 10 - 20: idx 1
			// 20 - 30: idx 2
			// 30 -   : idx 3

			//x.setTransform( -1, 0, 0, 1, 0, 0 );
			//for( 0 to -180 )

		}
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	width = w*ratio | 0;
	height = h*ratio | 0;

	centerX = width >> 1;
	centerY = height >> 1;

	canvas.width = width;
	canvas.height = height;

	canvas.style.width = w+"px";
	canvas.style.height = h+"px";

	scale( w );
	reset();
}

function init()
{
	if( !atlas )
	{
		atlas = new Image();
		atlas.src = "atlas.png";
	}

	if( !atlas.complete )
	{
		setTimeout( init, 1000 );
		return;
	}

	if( !(canvas = document.getElementById( "Ski" )) ||
		!(ctx = canvas.getContext( "2d" )) )
		return;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctx.webkitBackingStorePixelRatio ||
			ctx.mozBackingStorePixelRatio ||
			ctx.msBackingStorePixelRatio ||
			ctx.oBackingStorePixelRatio ||
			ctx.backingStorePixelRatio ||
			1);

	window.onresize = resize;
	resize();

	canvas.onmousedown = pointerDown;
	canvas.onmousemove = pointerMove;
	canvas.onmouseup = pointerUp;

	if( "ontouchstart" in canvas )
	{
		canvas.ontouchstart = pointerDown;
		canvas.ontouchmove = pointerMove;
		canvas.ontouchend = pointerUp;
	}

stats();

	last = new Date().getTime()-16;
	run();
}

window.onload = init;

</script>
</body>
</html>
