<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>2Ski</title>
<style>

body
{
	background: #d5f6ff;
	margin: 0; padding: 0;
	overflow: hidden;
}

</style>
<body>
<canvas id="Ski">Sorry, can't run in this setup.</canvas>
<script>

"use strict";

// Mr. Doob's Stats
function stats()
{
var script=document.createElement('script');script.src='http://github.com/mrdoob/stats.js/raw/master/build/stats.min.js';document.body.appendChild(script);script=document.createElement('script');script.innerHTML='var interval=setInterval(function(){if(typeof Stats==\'function\'){clearInterval(interval);var stats=new Stats();stats.domElement.style.position=\'fixed\';stats.domElement.style.left=\'0px\';stats.domElement.style.top=\'0px\';stats.domElement.style.zIndex=\'10000\';document.body.appendChild(stats.domElement);setInterval(function(){stats.update();},1000/60);}},100);';document.body.appendChild(script);
}

// shim layer with setTimeout fallback
// see http://paulirish.com/2011/requestanimationframe-for-smart-animating/
window.requestAnimFrame =
	window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function( callback, element )
	{
		window.setTimeout(
			function()
			{
				callback( new Date().getTime() );
			},
			16 );
	};

var atlas,
	canvas,
	ctx,
	ratio,
	width,
	height,
	centerX,
	centerY,
	pointerLength = 0,
	pointerX = [],
	pointerY = [],
	last,
	factor,
	playersLength = 2,
	players = [],
	objectsLength = 20,
	objects = [],
	sprites = {},
	orientationsLength = 36,
	indexFactor = orientationsLength/2/Math.PI;

// DEBUG
var dbgAngle = 0,
	dbgFrame = 0,
	dbgSprite = 0,
	dbgSprites = [
		"Straight",
		"LeanLeft1",
		"LeanLeft2",
		"LeanLeft3",
		"LeanLeft2",
		"LeanLeft1",
		"Straight",
		"LeanRight1",
		"LeanRight2",
		"LeanRight3",
		"LeanRight2",
		"LeanRight1",
		"Straight",
		"Jump",
		"Straight",
		"LeanRight1",
		"Jump",
		];

function drawPlayers()
{
	for( var n = playersLength; n--; )
	{
		var p = players[n],
			s = p.sprite[indexFactor*dbgAngle | 0];

		ctx.drawImage(
			s,
			p.x-s.centerX,
			p.y-s.centerY );

ctx.setTransform( -1, 0, 0, -1, 0, 0 );
ctx.drawImage(
	s,
	p.x-s.centerX-width,
	p.y-s.centerY-height );
ctx.setTransform( 1, 0, 0, 1, 0, 0 );
	}

	// DEBUG
	dbgAngle += .001;
	if( dbgAngle > 6.2831 )
		dbgAngle -= 6.2831;

	if( ++dbgFrame > 20 )
	{
		dbgFrame = 0;

		if( ++dbgSprite >= dbgSprites.length )
			dbgSprite = 0;

		for( var n = playersLength; n--; )
		{
			var p = players[n];

			p.sprite = sprites[
				(n & 1 ?  "skierBlue" : "skierYellow")+
				dbgSprites[dbgSprite]];
		}
	}
}

function drawObjects()
{
	for( var n = objectsLength; n--; )
	{
		var o = objects[n],
			s = o.sprite;

		ctx.drawImage(
			s,
			o.x-s.centerX,
			o.y-s.centerY );

ctx.setTransform( -1, 0, 0, -1, 0, 0 );
ctx.drawImage(
	s,
	o.x-s.centerX-width,
	o.y-s.centerY-height );
ctx.setTransform( 1, 0, 0, 1, 0, 0 );
	}
}

function draw()
{
	ctx.clearRect( 0, 0, width, height );

	drawObjects();
	drawPlayers();
}

function ski()
{
}

function run( now )
{
	now = now || new Date().getTime();
	factor = 16/(now-last);
	last = now;

	ski();
	draw();

	requestAnimFrame( run );
}

function setPointers( ev )
{
	var e = ev || event;

	if( e.touches )
	{
		pointerLength = e.touches.length;

		for( var n = 0; n < pointerLength; ++n )
		{
			var t = e.touches[n];

			pointerX[n] = t.pageX;
			pointerY[n] = t.pageY;
		}
	}
	else if( typeof e.clientX !== "undefined" )
	{
		pointerX[0] = e.clientX;
		pointerY[0] = e.clientY;
		pointerLength = 1;
	}
	else if( typeof e.pageX !== "undefined" )
	{
		pointerX[0] = e.pageX;
		pointerY[0] = e.pageY;
		pointerLength = 1;
	}
}

function pointerUp( ev )
{
	pointerLength = 0;

	ev.preventDefault();
	return false;
}

function pointerMove( ev )
{
	if( pointerLength )
		setPointers( ev );

	ev.preventDefault();
	return false;
}

function pointerDown( ev )
{
	setPointers( ev );

	ev.preventDefault();
	return false;
}

function reset()
{
	var cell = width/playersLength,
		x = cell >> 1,
		y = centerY*1.75 | 0;

	for( var n = playersLength; n--; x += cell )
		players[n] = {
			x: x,
			y: y,
			sprite: sprites[
				n & 1 ?
				"skierBlueStraight" :
				"skierYellowStraight"] };

	for( var n = objectsLength; n--; )
		objects[n] = {
			x: Math.random()*width | 0,
			y: centerY+(Math.random()*centerY | 0),
			sprite: sprites.tree
		};
}

function scale( styleWidth )
{
	var frames = {
			skierBlueStraight: {
				rotate: true,
				frame: {/*skier-blue-straight*/x:121,y:335,w:25,h:54}
			},
			skierBlueJump: {
				rotate: true,
				frame: {/*skier-blue-jump*/x:48,y:335,w:48,h:54}
			},
			skierBlueLeanLeft1: {
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:208,y:256,w:24,h:59}
			},
			skierBlueLeanLeft2: {
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:92,y:256,w:32,h:64}
			},
			skierBlueLeanLeft3: {
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:154,y:256,w:30,h:63}
			},
			skierBlueLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:208,y:256,w:24,h:59}
			},
			skierBlueLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:92,y:256,w:32,h:64}
			},
			skierBlueLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:154,y:256,w:30,h:63}
			},
			skierBlueCrashed: {
				frame: {/*skier-blue-crashed*/x:178,y:335,w:32,h:42}
			},
			skierYellowStraight: {
				rotate: true,
				frame: {/*skier-yellow-straight*/x:96,y:335,w:25,h:54}
			},
			skierYellowJump: {
				rotate: true,
				frame: {/*skier-yellow-jump*/x:0,y:335,w:48,h:54}
			},
			skierYellowLeanLeft1: {
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:184,y:256,w:24,h:59}
			},
			skierYellowLeanLeft2: {
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:60,y:256,w:32,h:64}
			},
			skierYellowLeanLeft3: {
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:124,y:256,w:30,h:63}
			},
			skierYellowLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:184,y:256,w:24,h:59}
			},
			skierYellowLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:60,y:256,w:32,h:64}
			},
			skierYellowLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:124,y:256,w:30,h:63}
			},
			skierYellowCrashed: {
				frame: {/*skier-yellow-crashed*/x:146,y:335,w:32,h:42}
			},
			tree: {
				frame: {/*tree*/x:0,y:256,w:60,h:79}
			},
			hump: {
				frame: {/*hump*/x:0,y:0,w:256,h:256}
			}
		},
		ref = frames.hump.frame.w,
		step = Math.PI*2/orientationsLength,
		scale;

	if( styleWidth >= ref )
		scale = 1;
	else
		scale = width/ref;

	sprites = {};

	for( var name in frames )
	{
		var sprite = frames[name],
			f = sprite.frame,
			w = f.w*scale | 0,
			h = f.h*scale | 0;

		if( sprite.rotate )
		{
			var size = Math.max( w, h )*scale | 0,
				center = size >> 1,
				a = [];

			for( var o = orientationsLength; o--; )
			{
				var c = document.createElement( "canvas" ),
					x = c.getContext( "2d" ),
					angle = o*step;

				c.width = size;
				c.height = size;

				c.centerX = center;
				c.centerY = center;

				if( sprite.mirror )
				{
					x.setTransform( -1, 0, 0, 1, 0, 0 );
					x.translate( -center, center );
					x.rotate( -angle );
				}
				else
				{
					x.translate( center, center );
					x.rotate( angle );
				}

				x.drawImage(
					atlas,
					f.x,
					f.y,
					f.w,
					f.h,
					-w >> 1,
					-h >> 1,
					w,
					h );

				a[o] = c;
			}

			sprites[name] = a;
		}
		else
		{
			var c = document.createElement( "canvas" ),
				x = c.getContext( "2d" );

			c.width = w;
			c.height = h;

			c.centerX = w >> 1;
			c.centerY = h >> 1;

			x.drawImage(
				atlas,
				f.x,
				f.y,
				f.w,
				f.h,
				0,
				0,
				w,
				h );

			sprites[name] = c;
		}
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	width = w*ratio | 0;
	height = h*ratio | 0;

	centerX = width >> 1;
	centerY = height >> 1;

	canvas.width = width;
	canvas.height = height;

	canvas.style.width = w+"px";
	canvas.style.height = h+"px";

	scale( w );
	reset();
}

function init()
{
	if( !atlas )
	{
		atlas = new Image();
		atlas.src = "atlas.png";
	}

	if( !atlas.complete )
	{
		setTimeout( init, 1000 );
		return;
	}

	if( !(canvas = document.getElementById( "Ski" )) ||
		!(ctx = canvas.getContext( "2d" )) )
		return;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctx.webkitBackingStorePixelRatio ||
			ctx.mozBackingStorePixelRatio ||
			ctx.msBackingStorePixelRatio ||
			ctx.oBackingStorePixelRatio ||
			ctx.backingStorePixelRatio ||
			1);

	window.onresize = resize;
	resize();

	canvas.onmousedown = pointerDown;
	canvas.onmousemove = pointerMove;
	canvas.onmouseup = pointerUp;

	if( "ontouchstart" in canvas )
	{
		canvas.ontouchstart = pointerDown;
		canvas.ontouchmove = pointerMove;
		canvas.ontouchend = pointerUp;
	}

stats();
	last = new Date().getTime()-16;
	run();
}

window.onload = init;

</script>
</body>
</html>
