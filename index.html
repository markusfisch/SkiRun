<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>2Ski</title>
<style>

body
{
	background: #d5f6ff;
	margin: 0; padding: 0;
	overflow: hidden;
}

canvas
{
	position: fixed;
}

</style>
<body>
<script>

"use strict";

// Mr. Doob's Stats
function stats()
{
var script=document.createElement('script');script.src='http://github.com/mrdoob/stats.js/raw/master/build/stats.min.js';document.body.appendChild(script);script=document.createElement('script');script.innerHTML='var interval=setInterval(function(){if(typeof Stats==\'function\'){clearInterval(interval);var stats=new Stats();stats.domElement.style.position=\'fixed\';stats.domElement.style.left=\'0px\';stats.domElement.style.top=\'0px\';stats.domElement.style.zIndex=\'10000\';document.body.appendChild(stats.domElement);setInterval(function(){stats.update();},1000/60);}},100);';document.body.appendChild(script);
}

// shim layer with setTimeout fallback
// see http://paulirish.com/2011/requestanimationframe-for-smart-animating/
window.requestAnimFrame =
	window.requestAnimationFrame ||
	window.webkitRequestAnimationFrame ||
	window.mozRequestAnimationFrame ||
	window.oRequestAnimationFrame ||
	window.msRequestAnimationFrame ||
	function( callback, element )
	{
		window.setTimeout(
			function()
			{
				callback( new Date().getTime() );
			},
			16 );
	};

var atlas,
	canvas1,
	canvas2,
	ctx1,
	ctx2,
	ratio,
	upsideDown,
	width,
	height,
	mapWidth,
	mapHeight,
	pointerLength = 0,
	pointerX = [],
	pointerY = [],
	last,
	factor,
	playersLength = 2,
	players = [],
	objectsLength = 20,
	objects = [],
	sprites = {},
	orientationsLength = 36,
	indexFactor = orientationsLength/2/Math.PI;

// DEBUG
var dbgAngle = 0,
	dbgFrame = 0,
	dbgSprite = 0,
	dbgSprites = [
		"Straight",
		"LeanLeft1",
		"LeanLeft2",
		"LeanLeft3",
		"LeanLeft2",
		"LeanLeft1",
		"Straight",
		"LeanRight1",
		"LeanRight2",
		"LeanRight3",
		"LeanRight2",
		"LeanRight1",
		"Straight",
		"Jump",
		"Straight",
		"LeanRight1",
		"Jump",
		];

function drawPlayers()
{
	for( var n = playersLength; n--; )
	{
		var p = players[n],
			s = p.sprite[indexFactor*dbgAngle | 0],
			x = p.x-s.centerX,
			y = p.y-s.centerY;

		ctx2.drawImage( s, x, y );

		if( upsideDown )
		{
			var a = (dbgAngle+Math.PI) % (Math.PI*2);

			s = p.sprite[indexFactor*a | 0];
			y = height-p.y-s.centerY;
		}

		ctx1.drawImage( s, x, y );
	}

	// DEBUG
	dbgAngle += .01;
	if( dbgAngle > 6.2831 )
		dbgAngle -= 6.2831;

	if( ++dbgFrame > 5 )
	{
		dbgFrame = 0;

		if( ++dbgSprite >= dbgSprites.length )
			dbgSprite = 0;

		for( var n = playersLength; n--; )
		{
			var p = players[n];

			p.sprite = sprites[
				(n & 1 ?  "skierBlue" : "skierYellow")+
				dbgSprites[dbgSprite]];
		}
	}
}

function drawObjects()
{
	for( var n = objectsLength; n--; )
	{
		var o = objects[n],
			s = o.sprite,
			x = o.x-s.centerX,
			y = o.y-s.centerY;

		ctx2.drawImage( s, x, y );
	}

	for( var n = objectsLength; n--; )
	{
		var o = objects[n],
			s,
			x = o.x-s.centerX,
			y;

		if( upsideDown )
		{
			s = sprites.treeUpsideDown;
			y = height-o.y-s.centerY;
		}
		else
		{
			s = o.sprite;
			y = o.y-s.centerY;
		}

		ctx1.drawImage( s, x, y );
	}
}

function draw()
{
	ctx1.clearRect( 0, 0, width, height );

	ctx2.fillStyle = "#c5e6ef";
	ctx2.fillRect( 0, 0, width, height );

	drawObjects();
	drawPlayers();
}

function ski()
{
}

function run( now )
{
	now = now || new Date().getTime();
	factor = 16/(now-last);
	last = now;

	ski();
	draw();

	requestAnimFrame( run );
}

function setPointers( ev )
{
	var e = ev || event;

	if( e.touches )
	{
		pointerLength = e.touches.length;

		for( var n = 0; n < pointerLength; ++n )
		{
			var t = e.touches[n];

			pointerX[n] = t.pageX;
			pointerY[n] = t.pageY;
		}
	}
	else if( typeof e.clientX !== "undefined" )
	{
		pointerX[0] = e.clientX;
		pointerY[0] = e.clientY;
		pointerLength = 1;
	}
	else if( typeof e.pageX !== "undefined" )
	{
		pointerX[0] = e.pageX;
		pointerY[0] = e.pageY;
		pointerLength = 1;
	}
}

function pointerUp( ev )
{
	pointerLength = 0;

	ev.preventDefault();
	return false;
}

function pointerMove( ev )
{
	if( pointerLength )
		setPointers( ev );

	ev.preventDefault();
	return false;
}

function pointerDown( ev )
{
	setPointers( ev );

	ev.preventDefault();
	return false;
}

function reset()
{
	var cell = width/playersLength,
		x = cell >> 1,
		y = height*.9 | 0;

	for( var n = playersLength; n--; x += cell )
		players[n] = {
			x: x,
			y: y,
			sprite: sprites[
				n & 1 ?
				"skierBlueStraight" :
				"skierYellowStraight"] };

	mapWidth = width;
	mapHeight = height;

	for( var n = objectsLength, y = 0;
		n--;
		y += Math.random()*.1 )
	{
		var x = Math.random();

		objects[n] = {
			x: (n % 2 ? (x < .5 ? 0 : .9)+x*.1 : x)*mapWidth | 0,
			y: y*mapHeight | 0,
			sprite: sprites.tree };
	}
}

function scale( styleWidth )
{
	var frames = {
			skierBlueStraight: {
				rotate: true,
				frame: {/*skier-blue-straight*/x:135,y:345,w:25,h:54}
			},
			skierBlueJump: {
				rotate: true,
				frame: {/*skier-blue-jump*/x:54,y:345,w:48,h:54}
			},
			skierBlueLeanLeft1: {
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:234,y:262,w:24,h:59}
			},
			skierBlueLeanLeft2: {
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:102,y:262,w:32,h:64}
			},
			skierBlueLeanLeft3: {
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:172,y:262,w:30,h:63}
			},
			skierBlueLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:234,y:262,w:24,h:59}
			},
			skierBlueLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:102,y:262,w:32,h:64}
			},
			skierBlueLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:172,y:262,w:30,h:63}
			},
			skierBlueCrashed: {
				frame: {/*skier-blue-crashed*/x:200,y:345,w:32,h:42}
			},
			skierYellowStraight: {
				rotate: true,
				frame: {/*skier-yellow-straight*/x:106,y:345,w:25,h:54}
			},
			skierYellowJump: {
				rotate: true,
				frame: {/*skier-yellow-jump*/x:2,y:345,w:48,h:54}
			},
			skierYellowLeanLeft1: {
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:206,y:262,w:24,h:59}
			},
			skierYellowLeanLeft2: {
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:66,y:262,w:32,h:64}
			},
			skierYellowLeanLeft3: {
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:138,y:262,w:30,h:63}
			},
			skierYellowLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:206,y:262,w:24,h:59}
			},
			skierYellowLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:66,y:262,w:32,h:64}
			},
			skierYellowLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:138,y:262,w:30,h:63}
			},
			skierYellowCrashed: {
				frame: {/*skier-yellow-crashed*/x:164,y:345,w:32,h:42}
			},
			tree: {
				frame: {/*tree*/x:2,y:262,w:60,h:79}
			},
			treeUpsideDown: {
				upsideDown: true,
				frame: {/*tree*/x:2,y:262,w:60,h:79}
			},
			hump: {
				frame: {/*hump*/x:2,y:2,w:256,h:256}
			}
		},
		step = Math.PI*2/orientationsLength,
		/*ref = frames.skierBlueStraight.frame.w,
		target = styleWidth*.05 | 0,
		scale;*/
		scale = width*.05/frames.skierBlueStraight.frame.w;

	/*if( target >= ref )
		scale = 1;
	else
		scale = target/ref;*/

	sprites = {};

	for( var name in frames )
	{
		var sprite = frames[name],
			f = sprite.frame,
			w = f.w*scale | 0,
			h = f.h*scale | 0;

		if( sprite.rotate )
		{
			var size = Math.max( w, h )*scale | 0,
				center = size >> 1,
				a = [];

			for( var o = orientationsLength; o--; )
			{
				var c = document.createElement( "canvas" ),
					x = c.getContext( "2d" ),
					angle = o*step;

				c.width = size;
				c.height = size;

				c.centerX = center;
				c.centerY = center;

				if( sprite.mirror )
				{
					x.setTransform( -1, 0, 0, 1, 0, 0 );
					x.translate( -center, center );
					x.rotate( -angle );
				}
				else if( sprite.upsideDown )
				{
					x.setTransform( -1, 0, 0, -1, 0, 0 );
					x.translate( -center, -center );
					x.rotate( -angle );
				}
				else
				{
					x.translate( center, center );
					x.rotate( angle );
				}

				x.drawImage(
					atlas,
					f.x,
					f.y,
					f.w,
					f.h,
					-w >> 1,
					-h >> 1,
					w,
					h );

				a[o] = c;
			}

			sprites[name] = a;
		}
		else
		{
			var c = document.createElement( "canvas" ),
				x = c.getContext( "2d" ),
				l = 0,
				t = 0;

			c.width = w;
			c.height = h;

			c.centerX = w >> 1;
			c.centerY = h >> 1;

			if( sprite.mirror )
			{
				x.setTransform( -1, 0, 0, 1, 0, 0 );
				l = -w;
			}
			else if( sprite.upsideDown )
			{
				x.setTransform( -1, 0, 0, -1, 0, 0 );
				l = -w;
				t = -h;
			}

			x.drawImage(
				atlas,
				f.x,
				f.y,
				f.w,
				f.h,
				l,
				t,
				w,
				h );

			sprites[name] = c;
		}
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	if( w > h )
	{
		w >>= 1;
		canvas2.style.left = w+"px";
		canvas2.style.top = "0px";
	}
	else
	{
		h >>= 1;
		canvas2.style.left = "0px";
		canvas2.style.top = h+"px";
	}

	width = w*ratio | 0;
	height = h*ratio | 0;

	canvas1.width = canvas2.width = width;
	canvas1.height = canvas2.height = height;

	canvas1.style.width = canvas2.style.width = w+"px";
	canvas1.style.height = canvas2.style.height = h+"px";

	scale( w );
	reset();
}

function init()
{
	if( !atlas )
	{
		atlas = new Image();
		atlas.src = "atlas.png";
	}

	if( !atlas.complete )
	{
		setTimeout( init, 1000 );
		return;
	}

	if( !(canvas1 = document.createElement( "canvas" )) ||
		!(ctx1 = canvas1.getContext( "2d" )) ||
		!(canvas2 = document.createElement( "canvas" )) ||
		!(ctx2 = canvas2.getContext( "2d" )) )
		return;

	ratio =
		(window.devicePixelRatio || 1)/
		(ctx1.webkitBackingStorePixelRatio ||
			ctx1.mozBackingStorePixelRatio ||
			ctx1.msBackingStorePixelRatio ||
			ctx1.oBackingStorePixelRatio ||
			ctx1.backingStorePixelRatio ||
			1);

	upsideDown = navigator.userAgent.match(
		/ipad|iphone|ipod|android|blackberry|webos/i );

	window.onresize = resize;
	resize();

	canvas1.onmousedown = canvas2.onmousedown = pointerDown;
	canvas1.onmousemove = canvas2.onmousemove = pointerMove;
	canvas1.onmouseup = canvas2.onmouseup = pointerUp;

	if( "ontouchstart" in canvas1 )
	{
		canvas1.ontouchstart = canvas2.ontouchstart = pointerDown;
		canvas1.ontouchmove = canvas2.ontouchmove = pointerMove;
		canvas1.ontouchend = canvas2.ontouchend = pointerUp;
	}

	document.body.appendChild( canvas1 );
	document.body.appendChild( canvas2 );

stats();
	last = new Date().getTime()-16;
	run();
}

window.onload = init;

</script>
</body>
</html>
