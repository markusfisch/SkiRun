<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>2Ski</title>
<style>

body
{
	background: #d5f6ff;
	margin: 0; padding: 0;
	overflow: hidden;
}

canvas
{
	position: fixed;
}

</style>
<body>
<script>

"use strict";

Math.PI2 = Math.PI2 || Math.PI/2;
Math.TAU = Math.TAU || Math.PI*2;
Math.SINPI2 = Math.SINPI2 || Math.sin( Math.PI2 );

var requestAnimFrame =
		window.webkitRequestAnimationFrame ||
		window.mozRequestAnimationFrame ||
		window.msRequestAnimationFrame ||
		window.oRequestAnimationFrame ||
		window.requestAnimationFrame ||
		function( callback )
		{
			setTimeout( callback, 16 );
		},
	playersLength = 2,
	players = [],
	atlas,
	ratio,
	width,
	height,
	centerX,
	centerY,
	skierScreenTop,
	skierScreenBottom,
	pointerLength = 0,
	pointerX = [],
	pointerY = [],
	keysDown = [],
	now,
	last,
	factor,
	objectsLength,
	objects = [],
	sprites = {},
	mobile = navigator.userAgent.match(
		/ipad|iphone|ipod|android|blackberry|webos/i ),
	orientationsLength = 36,
	steepness = .2,
	gravityVector = -Math.PI2,
	gravityX = Math.cos( gravityVector )*steepness,
	gravityY = Math.sin( gravityVector )*steepness,
	gravityLength = Math.sqrt( gravityX*gravityX + gravityY*gravityY ),
	indexFactor = orientationsLength/2/Math.PI,
	reverseFactor = 1/Math.PI2,
	maxSpeedFactor,
	slopeWidth,
	slopeHeight,
	skiWidth,
	skiGap2,
	skiGap2PlusSki2,
	skiGap2MinusSki2,
	skiLength2,
	marksTimerMax = 15;

function drawPlayers( ctx, left, top, upsideDown )
{
	for( var n = playersLength; n--; )
	{
		var p = players[n],
			heading = (p.skiAngle+Math.PI2) % Math.TAU,
			x = p.x-left,
			y = p.y-top;

		if( upsideDown )
		{
			heading = (heading+Math.PI) % Math.TAU;
			y = height-y;
		}

		var sprite = p.sprite[indexFactor*heading | 0];

		x -= sprite.centerX;
		y -= sprite.centerY;

		ctx.drawImage( sprite, x, y );

		if( !p.crashed &&
			!--p.marksTimer )
		{
			x = p.x;
			y = p.y;

			var sx = p.sx,
				sy = p.sy,
				leftX = x+sy*skiGap2PlusSki2,
				leftY = y+sx*skiGap2PlusSki2;

			if( leftX != p.marksLastX ||
				leftY != p.marksLastY )
			{
				var m = p.mark,
					rightX = x+sy*skiGap2MinusSki2,
					rightY = y+sx*skiGap2MinusSki2,
					lx = sx*skiLength2,
					ly = sy*skiLength2;

				p.marksLastX = leftX;
				p.marksLastY = leftY;

				p.marksLeftTopX[m] = leftX+lx | 0;
				p.marksLeftTopY[m] = leftY+ly | 0;
				p.marksLeftBottomX[m] = rightX-lx | 0;
				p.marksLeftBottomY[m] = rightY-ly | 0;

				leftX = x-sy*skiGap2MinusSki2;
				leftY = y+sx*skiGap2MinusSki2;
				rightX = x-sy*skiGap2PlusSki2,
				rightY = y+sx*skiGap2PlusSki2,

				p.marksRightTopX[m] = leftX+lx | 0;
				p.marksRightTopY[m] = leftY+ly | 0;
				p.marksRightBottomX[m] = rightX-lx | 0;
				p.marksRightBottomY[m] = rightY-ly | 0;

				++p.mark;
			}

			p.marksTimer = marksTimerMax;
		}
	}
}

function drawObjects( ctx, left, top, upsideDown, player )
{
	var px = player.x,
		py = player.y;

	for( var n = objectsLength; n--; )
	{
		var o = objects[n],
			ox = o.x,
			oy = o.y,
			x = ox-left,
			y = oy-top,
			sprite;

		if( upsideDown )
		{
			sprite = sprites.treeUpsideDown;
			y = height-y;
		}
		else
			sprite = sprites.tree;

		if( x > width ||
			x < 0 ||
			y > height ||
			y < 0 )
			continue;

		var cx = sprite.centerX,
			cy = sprite.centerY;

		if( !player.crashed &&
			py >= oy-cy &&
			py <= oy+cy &&
			px >= ox-cx &&
			px <= ox+cx )
			player.crashed = true;

		x -= cx;
		y -= cy;

		ctx.drawImage( sprite, x, y );
	}
}

function drawMarks( ctx, left, top )
{
	ctx.fillStyle = "#b5d6df";

	for( var n = playersLength; n--; )
	{
		var p = players[n],
			l = p.mark-1,
			topX = p.marksLeftTopX,
			topY = p.marksLeftTopY,
			bottomX = p.marksLeftBottomX,
			bottomY = p.marksLeftBottomY;

		if( !l )
			continue;

		for( var s = 2; s--; )
		{
			/*var m = l,
				set = false;

			ctx.beginPath();

			while( m-- )
			{
				var x = topX[m]-left,
					y = topY[m]-top;

				if( !set )
				{
					ctx.moveTo( x, y );
					set = true;
				}
				else
					ctx.lineTo( x, y );

				if( y > height )
					break;
			}

			do
			{
				var x = bottomX[m]-left,
					y = bottomY[m]-top;

				ctx.lineTo( x, y );

			} while( ++m < l );

			ctx.closePath();
			ctx.fill();*/

			for( var m = l; ; )
			{
				var next = m,
					y;

				if( --next < 0 )
					break;

				ctx.beginPath();

				ctx.moveTo(
					topX[m]-left,
					topY[m]-top );
				ctx.lineTo(
					bottomX[m]-left,
					bottomY[m]-top );

				ctx.lineTo(
					bottomX[next]-left,
					(y = bottomY[next]-top) );
				ctx.lineTo(
					topX[next]-left,
					topY[next]-top );

				ctx.closePath();
				ctx.fill();

				if( y > height )
					break;

				m = next;
			}

			if( !s )
				break;

			topX = p.marksRightTopX;
			topY = p.marksRightTopY;
			bottomX = p.marksRightBottomX;
			bottomY = p.marksRightBottomY;
		}
	}
}

function draw()
{
	for( var n = playersLength; n--; )
	{
		var p = players[n],
			ctx = p.ctx,
			upsideDown = p.upsideDown,
			x = p.x,
			y = p.y,
			left = x-centerX,
			top = y-skierScreenTop,
			right = x+centerX,
			bottom = y+skierScreenBottom;

		ctx.fillStyle = n & 1 ? "#d5f6ff" : "#c5e6ef";
		ctx.fillRect( 0, 0, width, height );

		drawMarks( ctx, left, top );
		drawObjects( ctx, left, top, upsideDown, p );
		drawPlayers( ctx, left, top, upsideDown );
	}
}

function turn( player, mod )
{
	var h = player.skiAngle;

	h += mod;

	if( h < 0 )
		h += Math.TAU;
	else if( h > Math.TAU )
		h -= Math.TAU;

	h %= Math.TAU;

	player.skiAngle = h;
}

function input()
{
	var step = .05,
		p;

	if( !(p = players[0]).crashed )
	{
		if( keysDown[65] )
			turn( p, -step );
		else if( keysDown[68] )
			turn( p, step );
	}

	if( playersLength > 1 &&
		!(p = players[1]).crashed )
	{
		if( keysDown[37] )
			turn( p, -step );
		else if( keysDown[39] )
			turn( p, step );
	}

	if( playersLength > 2 &&
		!(p = players[2]).crashed )
	{
		if( keysDown[72] )
			turn( p, -step );
		else if( keysDown[76] )
			turn( p, step );
	}

	for( var n = pointerLength; n--; )
	{
		var x = pointerX[n],
			y = pointerY[n],
			p = players[x/width | 0];

		if( p.crashed )
			continue;

		turn( p, -step/centerX*(centerX-(x % width)) );
	}
}

function ski()
{
	var alive = 0;

	for( var n = playersLength; n--; )
	{
		var p = players[n];

		if( p.crashed ||
			p.y < 0 )
			continue;

		var skiAngle = p.skiAngle,
			sx = (p.sx = Math.cos( skiAngle )),
			sy = (p.sy = Math.sin( skiAngle )),
			vx = p.vx,
			vy = p.vy,
			a = gravityVector-skiAngle,
			d = (a+Math.TAU) % Math.TAU,
			x,
			y;

		// difference from -PI to +PI
		if( d > Math.PI )
			d -= Math.TAU;

		var r = Math.abs( d );

		// translate maximum to PI/2
		if( d > Math.PI2 )
			d = Math.PI2-d+Math.PI2;
		else if( d < -Math.PI2 )
			d = -Math.PI2-d+-Math.PI2;

		if( d > 0 )
		{
			x = sy;
			y = -sx;
		}
		else
		{
			x = -sy;
			y = sx;
		}

		var l = gravityLength*
			Math.sin( Math.abs( d ) )/
			Math.SINPI2;

		x *= l;
		y *= l;

		x += gravityX;
		y += gravityY;

		// moving backwards should be slower
		if( r > Math.PI2 )
		{
			r = 1-reverseFactor*(r-Math.PI2);
			x *= r;
			y *= r;
		}

		// timing
		x *= factor;
		y *= factor;

		vx += x;
		vy += y;

		// resistance
		vx -= vx*maxSpeedFactor;
		vy -= vy*maxSpeedFactor;

		p.x += vx;
		p.y += vy;
		p.vx = vx;
		p.vy = vy;

		++alive;
	}

	return alive;
}

function run()
{
	now = new Date().getTime();
	factor = 16/(now-last);
	last = now;

	input();

	if( !ski() )
		return;

	draw();

	requestAnimFrame( run );
}

function getEvent( ev )
{
	return ev || event;
}

function setPointers( ev, set )
{
	var e = getEvent( ev );

	if( e.touches )
	{
		pointerLength = e.touches.length;

		for( var n = 0; n < pointerLength; ++n )
		{
			var t = e.touches[n];

			pointerX[n] = t.pageX*ratio;
			pointerY[n] = t.pageY*ratio;
		}
	}
	else if( typeof e.clientX !== "undefined" )
	{
		pointerX[0] = e.clientX*ratio;
		pointerY[0] = e.clientY*ratio;
		pointerLength = 1;
	}
	else if( typeof e.pageX !== "undefined" )
	{
		pointerX[0] = e.pageX*ratio;
		pointerY[0] = e.pageY*ratio;
		pointerLength = 1;
	}

	e.preventDefault();
	return false;
}

function pointerUp( ev )
{
	pointerLength = 0;

	getEvent( ev ).preventDefault();
	return false;
}

function pointerMove( ev )
{
	if( pointerLength )
		return setPointers( ev );

	getEvent( ev ).preventDefault();
	return false;
}

function pointerDown( ev )
{
	return setPointers( ev );
}

function setKey( ev, pressed )
{
	var e = getEvent( ev );

	keysDown[e.keyCode] = pressed;

	e.preventDefault();
	return false;
}

function keyUp( ev )
{
	return setKey( ev, false );
}

function keyDown( ev )
{
	return setKey( ev, true );
}

function reset()
{
	var ref = sprites.skierBlueStraight[0],
		rw = ref.width,
		rh = ref.height;

	slopeWidth = rw*playersLength*3;
	slopeHeight = sprites.tree.height*50;

	if( (skiWidth = rw*.1 | 0) < 2 )
		skiWidth = 2;

	if( (skiGap2 = rw*.0398 | 0) < 1 )
		skiGap2 = 1;

	skiGap2PlusSki2 = skiGap2+(skiWidth >> 1);
	skiGap2MinusSki2 = skiGap2-(skiWidth >> 1);
	skiLength2 = rh >> 1;

	objectsLength = 0;
	objects = [];

	for( var y = 1-(1/slopeHeight*rh*4);
		y > 0;
		y -= Math.random()*.05, ++objectsLength )
	{
		var x = Math.random();

		objects[objectsLength] = {
			x: (objectsLength % 2 ?
				(x < .5 ? 0 : .9)+x*.1 :
				x)*slopeWidth | 0,
			y: y*slopeHeight | 0,
			sprite: sprites.tree };
	}

	var cell = slopeWidth/playersLength,
		margin = rh << 1,
		x = cell >> 1,
		y = slopeHeight-margin;

	skierScreenTop = height-margin;
	skierScreenBottom = margin;

	for( var n = 0;
		n < playersLength;
		++n, x += cell )
	{
		var p = players[n];

		p.x = x;
		p.y = y;

		p.vx =
		p.vy =
		p.sx =
		p.sy =
		p.skiAngle = 0;

		p.marksTimer = marksTimerMax;
		p.mark =
		p.marksLastX =
		p.marksLastY = 0;
		p.marksLeftTopX = [];
		p.marksLeftTopY = [];
		p.marksLeftBottomX = [];
		p.marksLeftBottomY = [];
		p.marksRightTopX = [];
		p.marksRightTopY = [];
		p.marksRightBottomX = [];
		p.marksRightBottomY = [];

		p.sprite = sprites[
			(n & 1 ? "skierYellow" : "skierBlue")+"Straight"];
	}
}

function scale( styleWidth )
{
	var frames = {
			skierBlueStraight: {
				rotate: true,
				frame: {/*skier-blue-straight*/x:1543,y:2,w:103,h:222}
			},
			skierBlueJump: {
				rotate: true,
				frame: {/*skier-blue-jump*/x:1129,y:2,w:196,h:222}
			},
			skierBlueLeanLeft1: {
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:827,y:2,w:98,h:242}
			},
			skierBlueLeanLeft2: {
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:138,y:2,w:132,h:262}
			},
			skierBlueLeanLeft3: {
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:400,y:2,w:122,h:257}
			},
			skierBlueLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean1-left*/x:827,y:2,w:98,h:242}
			},
			skierBlueLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean2-left*/x:138,y:2,w:132,h:262}
			},
			skierBlueLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-blue-lean3-left*/x:400,y:2,w:122,h:257}
			},
			skierBlueCrashed: {
				frame: {/*skier-blue-crashed*/x:1891,y:2,w:130,h:173}
			},
			skierBlueBackwards: {
				frame: {/*skier-blue-backwards*/x:1891,y:2,w:130,h:173}
			},
			skierYellowStraight: {
				rotate: true,
				frame: {/*skier-yellow-straight*/x:1329,y:2,w:103,h:222}
			},
			skierYellowJump: {
				rotate: true,
				frame: {/*skier-yellow-jump*/x:929,y:2,w:196,h:222}
			},
			skierYellowLeanLeft1: {
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:725,y:2,w:98,h:242}
			},
			skierYellowLeanLeft2: {
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:2,y:2,w:132,h:262}
			},
			skierYellowLeanLeft3: {
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:274,y:2,w:122,h:257}
			},
			skierYellowLeanRight1: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean1-left*/x:725,y:2,w:98,h:242}
			},
			skierYellowLeanRight2: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean2-left*/x:2,y:2,w:132,h:262}
			},
			skierYellowLeanRight3: {
				mirror: true,
				rotate: true,
				frame: {/*skier-yellow-lean3-left*/x:274,y:2,w:122,h:257}
			},
			skierYellowCrashed: {
				frame: {/*skier-yellow-crashed*/x:1757,y:2,w:130,h:173}
			},
			skierYellowBackwards: {
				frame: {/*skier-yellow-backwards*/x:1757,y:2,w:130,h:173}
			},
			tree: {
				frame: {/*tree*/x:526,y:2,w:195,h:256}
			},
			treeUpsideDown: {
				upsideDown: true,
				frame: {/*tree*/x:526,y:2,w:195,h:256}
			},
			hump: {
				frame: {/*hump*/x:2,y:2,w:256,h:256}
			}
		},
		step = Math.TAU/orientationsLength,
		scale = Math.min( width, height )*.075/
			frames.skierBlueStraight.frame.w;

	sprites = {};

	for( var name in frames )
	{
		var sprite = frames[name],
			f = sprite.frame,
			w = f.w*scale | 0,
			h = f.h*scale | 0;

		if( sprite.rotate )
		{
			var size = Math.max( w, h ),
				center = size >> 1,
				a = [];

			for( var o = orientationsLength; o--; )
			{
				var c = document.createElement( "canvas" ),
					x = c.getContext( "2d" ),
					angle = o*step;

				c.width = size;
				c.height = size;

				c.centerX = center;
				c.centerY = center;

				if( sprite.mirror )
				{
					x.setTransform( -1, 0, 0, 1, 0, 0 );
					x.translate( -center, center );
					x.rotate( -angle );
				}
				else if( sprite.upsideDown )
				{
					x.setTransform( -1, 0, 0, -1, 0, 0 );
					x.translate( -center, -center );
					x.rotate( -angle );
				}
				else
				{
					x.translate( center, center );
					x.rotate( angle );
				}

				x.drawImage(
					atlas,
					f.x,
					f.y,
					f.w,
					f.h,
					-w >> 1,
					-h >> 1,
					w,
					h );

				a[o] = c;
			}

			sprites[name] = a;
		}
		else
		{
			var c = document.createElement( "canvas" ),
				x = c.getContext( "2d" ),
				l = 0,
				t = 0;

			c.width = w;
			c.height = h;

			c.centerX = w >> 1;
			c.centerY = h >> 1;

			if( sprite.mirror )
			{
				x.setTransform( -1, 0, 0, 1, 0, 0 );
				l = -w;
			}
			else if( sprite.upsideDown )
			{
				x.setTransform( -1, 0, 0, -1, 0, 0 );
				l = -w;
				t = -h;
			}

			x.drawImage(
				atlas,
				f.x,
				f.y,
				f.w,
				f.h,
				l,
				t,
				w,
				h );

			sprites[name] = c;
		}
	}
}

function resize()
{
	var w = window.innerWidth,
		h = window.innerHeight;

	w = w/playersLength | 0;

	for( var n = 0, x = 0;
		n < playersLength;
		++n, x += w )
	{
		var s = players[n].canvas.style;

		s.left = x+"px";
		s.top = "0px";
	}

	width = w*ratio | 0;
	height = h*ratio | 0;

	centerX = width >> 1;
	centerY = height >> 1;
	maxSpeedFactor = 17.25/Math.min( w, h );

	for( var n = playersLength; n--; )
	{
		var p = players[n],
			c = p.canvas;

		c.width = width;
		c.height = height;

		c.style.width = w+"px";
		c.style.height = h+"px";

		p.upsideDown = mobile ? (n & 1 ? false : true) : false;
	}

	scale( w );
	reset();
}

function create()
{
	var x;

	for( var n = playersLength; n--; )
	{
		var c;

		if( !(c = document.createElement( "canvas" )) ||
			!(x = c.getContext( "2d" )) )
			return;

		c.playerIndex = n;

		players[n] = {
			canvas: c,
			ctx: x };
	}

	ratio =
		(window.devicePixelRatio || 1)/
		(x.webkitBackingStorePixelRatio ||
			x.mozBackingStorePixelRatio ||
			x.msBackingStorePixelRatio ||
			x.oBackingStorePixelRatio ||
			x.backingStorePixelRatio ||
			1);
}

function init()
{
	if( !atlas )
	{
		atlas = new Image();
		atlas.src = "atlas.png";
	}

	if( !atlas.complete )
	{
		setTimeout( init, 1000 );
		return;
	}

	create();
	resize();

	var e = document.body;

	for( var n = playersLength; n--; )
		e.appendChild( players[n].canvas );

	window.onresize = resize;

	e.onkeydown = keyDown;
	e.onkeyup = keyUp;

	e.onmousedown = pointerDown;
	e.onmousemove = pointerMove;
	e.onmouseup = pointerUp;

	if( "ontouchstart" in e )
	{
		e.ontouchstart = pointerDown;
		e.ontouchmove = pointerMove;
		e.ontouchend = pointerUp;
	}

// Mr. Doob's Stats
function stats()
{
var script=document.createElement('script');script.src='http://github.com/mrdoob/stats.js/raw/master/build/stats.min.js';document.body.appendChild(script);script=document.createElement('script');script.innerHTML='var interval=setInterval(function(){if(typeof Stats==\'function\'){clearInterval(interval);var stats=new Stats();stats.domElement.style.position=\'fixed\';stats.domElement.style.left=\'0px\';stats.domElement.style.top=\'0px\';stats.domElement.style.zIndex=\'10000\';document.body.appendChild(stats.domElement);setInterval(function(){stats.update();},1000/60);}},100);';document.body.appendChild(script);
}
stats();

	last = new Date().getTime()-16;
	run();
}

window.onload = init;

</script>
</body>
</html>
